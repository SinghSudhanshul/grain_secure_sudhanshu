// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   // bcrypt hash
  role         String   // ADMIN, INSPECTOR, DEALER, AUDITOR, BENEFICIARY, PUBLIC
  name         String
  district     String?  // Geographic assignment for admins/inspectors
  beneficiaryId String?
  beneficiary   Beneficiary? @relation(fields: [beneficiaryId], references: [id])
  
  assignedCases    Case[]            @relation("AssignedCases")
  inspectorActions InspectorAction[]
  complaints       Complaint[]       @relation("ComplaintResolver")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model District {
  id            String        @id @default(uuid())
  name          String
  shops         FPSShop[]
  beneficiaries Beneficiary[]
  createdAt     DateTime      @default(now())
}

model FPSShop {
  id         String   @id @default(uuid())
  districtId String
  district   District @relation(fields: [districtId], references: [id])
  
  shopCode         String   @unique  // Government identifier
  name             String
  ownerName        String
  contactPhone     String
  licenseNumber    String
  zone             String
  address          String
  pincode          String?
  lat              Float
  lng              Float
  
  monthlyQuota        String   @default("{}") // JSON: {rice: 1000, wheat: 1500, sugar: 500}
  operationalStatus   String   @default("ACTIVE") // ACTIVE, SUSPENDED, CLOSED
  lastInspectionDate  DateTime?
  riskScore           Float    @default(0)
  
  transactions Transaction[]
  stockLogs    StockLog[]
  alerts       Alert[]
  complaints   Complaint[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Beneficiary {
  id            String   @id @default(uuid())
  rationCardId  String   @unique
  name          String
  age           Int
  gender        String
  familySize    Int
  incomeCategory String  @default("BPL") // BPL, APL, AAY
  aadhaarMasked String
  address       String
  pincode       String?
  phoneNumber   String?
  lat           Float?
  lng           Float?
  refPhotoUrl   String?
  
  monthlyEntitlement String  @default("{}") // JSON: {rice: 5, wheat: 10, sugar: 2}
  isActive           Boolean @default(true)
  enrollmentDate     DateTime @default(now())
  
  districtId String
  district   District @relation(fields: [districtId], references: [id])
  
  entitlements Entitlement[]
  transactions Transaction[]
  alerts       Alert[]
  users        User[]
  complaints   Complaint[]    @relation("BeneficiaryComplaints")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Entitlement {
  id            String      @id @default(uuid())
  beneficiaryId String
  beneficiary   Beneficiary @relation(fields: [beneficiaryId], references: [id])
  
  month   String  // YYYY-MM format
  riceKg  Float
  wheatKg Float
  sugarKg Float
  
  createdAt DateTime @default(now())
  
  @@unique([beneficiaryId, month])
}

model Transaction {
  id            String      @id @default(uuid())
  transactionId String      @unique @default(cuid())
  beneficiaryId String
  beneficiary   Beneficiary @relation(fields: [beneficiaryId], references: [id])
  
  fpsId String
  fps   FPSShop @relation(fields: [fpsId], references: [id])
  
  dateTime DateTime @default(now())
  
  riceKg  Float
  wheatKg Float
  sugarKg Float
  totalValue Float @default(0) // Monetary value at subsidized rates
  
  authMethod String  // OTP, FACE, MANUAL
  authStatus String  // SUCCESS, FAILED
  
  status String @default("CONFIRMED") // CONFIRMED, DISPUTED
  
  riskScore    Float  @default(0)
  anomalyType  String?
  anomalyFlags String? // JSON string of evidence
  
  verifiedByBeneficiary Boolean?  // Crowdsourced validation
  verificationDate      DateTime?
  
  alerts     Alert[]
  complaints Complaint[]
  
  createdAt DateTime @default(now())
}

model StockLog {
  id     String  @id @default(uuid())
  fpsId  String
  fps    FPSShop @relation(fields: [fpsId], references: [id])
  
  dateTime DateTime @default(now())
  
  riceIn   Float @default(0)
  riceOut  Float @default(0)
  wheatIn  Float @default(0)
  wheatOut Float @default(0)
  sugarIn  Float @default(0)
  sugarOut Float @default(0)
  
  createdAt DateTime @default(now())
}

model Alert {
  id String @id @default(uuid())
  
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  
  beneficiaryId String?
  beneficiary   Beneficiary? @relation(fields: [beneficiaryId], references: [id])
  
  fpsId String?
  fps   FPSShop? @relation(fields: [fpsId], references: [id])
  
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  description String
  evidence    String? // JSON string
  
  status String @default("OPEN") // OPEN, RESOLVED
  
  cases Case[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Case {
  id      String @id @default(uuid())
  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id])
  
  status String @default("OPEN") // OPEN, ASSIGNED, INVESTIGATING, RESOLVED
  
  assignedToId String?
  assignedTo   User?   @relation("AssignedCases", fields: [assignedToId], references: [id])
  
  verdict String? // FRAUD_CONFIRMED, FALSE_POSITIVE, NEED_MORE_INFO
  notes   String?
  
  actions InspectorAction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InspectorAction {
  id         String @id @default(uuid())
  caseId     String
  case       Case   @relation(fields: [caseId], references: [id])
  
  inspectorId String
  inspector   User   @relation(fields: [inspectorId], references: [id])
  
  actionType String // ASSIGNED, NOTE_ADDED, STATUS_CHANGED, VERDICT_GIVEN
  notes      String?
  
  createdAt DateTime @default(now())
}

model AuditLog {
  id          String @id @default(uuid())
  eventType   String
  metaJson    String
  prevHash    String
  currentHash String
  
  createdAt DateTime @default(now())
}

model Complaint {
  id          String @id @default(uuid())
  complaintId String @unique @default(cuid())
  
  beneficiaryId String
  beneficiary   Beneficiary @relation("BeneficiaryComplaints", fields: [beneficiaryId], references: [id])
  
  shopId      String?
  shop        FPSShop? @relation(fields: [shopId], references: [id])
  
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  
  complaintType String // NON_RECEIPT, QUANTITY_SHORT, QUALITY_ISSUE, OVERCHARGING, MISBEHAVIOR, OTHER
  description   String
  complaintDate DateTime @default(now())
  
  status   String @default("SUBMITTED") // SUBMITTED, ACKNOWLEDGED, UNDER_REVIEW, RESOLVED, CLOSED
  priority String @default("MEDIUM")     // LOW, MEDIUM, HIGH
  
  resolutionNotes String?
  resolvedById    String?
  resolvedBy      User?   @relation("ComplaintResolver", fields: [resolvedById], references: [id])
  resolutionDate  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([beneficiaryId])
  @@index([shopId])
  @@index([status])
}

model NetworkRelationship {
  id String @id @default(uuid())
  
  sourceType String // BENEFICIARY, SHOP, INSPECTOR, DISTRIBUTOR
  sourceId   String
  
  targetType String // BENEFICIARY, SHOP, INSPECTOR, DISTRIBUTOR
  targetId   String
  
  relationshipType String // TRANSACTION, SHARED_ADDRESS, SHARED_CONTACT, TEMPORAL_CORRELATION, PATTERN_SIMILARITY
  strength         Float  @default(0.5) // 0-1 connection confidence
  metadata         String @default("{}") // JSON with additional context
  
  detectedDate DateTime @default(now())
  createdAt    DateTime @default(now())
  
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([relationshipType])
  @@index([strength])
}
